<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>1:1 STOMP 채팅 테스트</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
<h2>1:1 STOMP 채팅 테스트</h2>

<label>채팅방 ID (roomId):</label>
<input type="text" id="roomId" placeholder="예: 5" /><br>

<label>내 사용자 ID (senderId):</label>
<input type="text" id="senderId" placeholder="예: 1" /><br><br>

<button onclick="connect()">채팅 연결</button><br><br>

<input type="text" id="message" placeholder="메시지를 입력하세요" />
<button onclick="sendMessage()">보내기</button>

<ul id="chat-list"></ul>

<script>
    let stompClient;

    function connect() {
        const socket = new SockJS("/portfolio");
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function () {
            const roomId = document.getElementById("roomId").value;
            if (!roomId) {
                alert("roomId를 입력해주세요!");
                return;
            }

            stompClient.subscribe(`/topic/chatroom/${roomId}`, function (response) {
                const message = JSON.parse(response.body);
                const chatList = document.getElementById("chat-list");
                const li = document.createElement("li");
                li.textContent = `[${message.sentAt}] ${message.sender} : ${message.content}`;
                chatList.appendChild(li);
            });

            alert("채팅 서버에 연결되었습니다!");
        }, function (error) {
            console.error("STOMP 연결 실패:", error);
            alert("연결에 실패했습니다.");
        });
    }

    function sendMessage() {
        const content = document.getElementById("message").value;
        const senderId = document.getElementById("senderId").value;
        const roomId = document.getElementById("roomId").value;

        if (!stompClient || !stompClient.connected) {
            alert("STOMP에 연결되지 않았습니다. '채팅 연결' 버튼을 눌러주세요.");
            return;
        }

        const payload = {
            sender: senderId,
            roomId: roomId,
            content: content
        };

        stompClient.send("/app/chat.send", {}, JSON.stringify(payload));
        document.getElementById("message").value = "";
    }
</script>
</body>
</html>
